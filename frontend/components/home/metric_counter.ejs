<script>
    function createCounter(data){
        console.log("Data: ", data);
        console.log(data.counter);
        const indiceRotacion = parseFloat(data.counter[0].indice_rotacion).toFixed(2);
        console.log("Índice de rotación formateado:", indiceRotacion);
        let content = " ";
        content += `
        <input type="hidden" id="_csrf" value="<%= csrfToken %>">
        <div class="level">
            <div class="level-item has-text-centered">
            <div>
                <h1 class="is-size-1 has-text-white"> ${indiceRotacion}% </h1>
                <div>
                    <div class="metric-wrapper">
                        <p class="headingVac">AVG metric rotation</p>
                        <i class="bi bi-caret-down-fill is-clickable size-icon" id="periodicity"></i>
                        <div class="options-container control" id="options"> 
                            <div>
                                <label class="radio" >
                                    <input type="radio" name="answer" value="1"/>
                                    Monthly
                                </label>
                                <label class="radio" >
                                    <input type="radio" name="answer" value="2"/>
                                    Trimestral
                                </label>
                                <label class="radio" >
                                    <input type="radio" name="answer" value="3" />
                                    Semestral
                                </label>
                                <label class="radio" >
                                    <input type="radio" name="answer" value="4"/>
                                    Yearly
                                </label>
                                <button class="approve-button"> SAVE </button>
                            </div>
                        </div>
                </div>
            </div>
            </div>
        </div>
        `
        // Inserta el contenido en un contenedor del DOM
        document.getElementById('metric-rotation-counter').innerHTML = content;

        const icon = document.getElementById("periodicity");
        icon.addEventListener("click", () => {
            const option = document.getElementById("options");
            option.style.display = option.style.display === "block" ? "none" : "block";
        });
        const radios = document.querySelectorAll("input[type='radio']");
        radios.forEach(radio => {
            radio.addEventListener("input", () => {
                console.log("Valor seleccionado:", radio.value);
            });
        });
        const saveButton = document.querySelector(".approve-button");
        if (saveButton) {
            saveButton.addEventListener("click", (e) => {
                e.preventDefault();
                get_info(); // llama al POST
            });
        }
    }

    const get_info = () => {
    const csrf = document.getElementById('_csrf').value;
    console.log("CSRF: ", csrf);
    const selectedRadio = document.querySelector("input[name='answer']:checked");
    const value = selectedRadio ? selectedRadio.value : null;

    fetch('/metric', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'x-csrf-token': csrf
        },
        body: JSON.stringify({
            valor: value,
        }),
    })
    .then(response => {
        console.log("Entro al response", response);
        return response.json()
    })
    .then(data => {
        console.log("Entro al data", data);
        createCounter(data);
    })
    .catch(e => {
        console.log("Entro al error", e);
        console.error(e)
    });
    };


    document.addEventListener("DOMContentLoaded", (e) => {
        get_info();
    })

</script>
  