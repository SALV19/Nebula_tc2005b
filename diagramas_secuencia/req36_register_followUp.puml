@startuml REQ_36
autonumber
actor SuperAdmin as S
boundary followUp.routes.js as Route
boundary register_followUp.ejs as Register
control register.controller.js as SController
entity register_followUp.model as SModel
entity indicators.model as IModel
entity periodic_eval.model as QFollow
entity periodic_eval.model as PEval
entity collabs.model as cm
entity questions_answers.model as Questions
entity indicators_metrics.model as IMetrics
database Nebula as db

' --- GET COLLABS ---
activate S
S -> Route : fetch (`/follow_ups/Register`)

activate Route
Route -> SController : get_register()
deactivate Route

activate SController
SController ->> cm : fetchAllCompleteName()

activate cm
cm ->> db : execute('SELECT C.id_colaborador, nombre, apellidos FROM colaborador C, equipo E WHERE C.id_colaborador = E.id_colaborador AND (id_rol = 1 OR id_rol = 2)')

activate db
db ->> cm : colaboradores
deactivate db

cm -->> SController : colaboradores
deactivate cm 

SController ->> PEval : fetchAllQuestions()

activate PEval
PEval ->> db : SELECT * FROM preguntas_evaluacion
activate db
db ->> PEval : questions
deactivate db

PEval -->> SController : questions
deactivate PEval 


' --- GET INFO INDICADORES ---
SController ->> IModel : fetchAllindicators()
activate IModel 
IModel ->> db : indicador
activate db
db -->> IModel : indicador
deactivate db
IModel -->> SController : indicador
deactivate IModel 

SController -> S : JSON response (colaboradores, questions, indicator)
deactivate SController

' ---- REGISTER FOLLOW UP ----
S -> Route : fetch('/post_follow_ups', { method: 'POST' })

activate Route
Route -> SController : post_follow_ups()
deactivate Route

activate SController
create QFollow
SController -> QFollow: new QuestionsFollow(id_colaborador, fechaAgendada)
SController -> QFollow: save()

activate QFollow
QFollow -> db: INSERT INTO evaluaciones_de_seguimiento
activate db
db -->> QFollow: id_evaluacion
deactivate db

QFollow -->> SController: id_evaluacion
deactivate QFollow

create Questions
SController -> Questions: new Questions(id_pregunta, id_evaluation, respuesta)
SController -> Questions : save()

activate Questions
Questions -> db: INSERT INTO respuestas_evaluacion
activate db
db -->> Questions : Query OK
deactivate db 
Questions -->> SController : Promesa
deactivate Questions

create IMetrics
SController -> IMetrics : new Indicators_metrics(id_evaluation, id_indicador, valor_metrica)
SController -> IMetrics : save()

activate IMetrics
IMetrics -> db : INSERT INTO indicadores_metricas
activate db
db -->> IMetrics : Query OK
deactivate db 
IMetrics -->> SController: Promesa
deactivate IMetrics 

SController -> S : JSON response ("EvaluaciÃ³n guardada correctamente", id_evaluation)
deactivate SController

S -> S : window.location.href = "/follow_ups"
deactivate S

@enduml
